<% cache do %>

<div class="container-lg">

  <h1 class="text-center mb-3 display-4">
    M6 Link Shortener
  </h1>

  <div class="card">
    <div class="card-body">

      <p>
        Generate a shortened link.
      </p>

      <form id="shortlink-form">
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>

        <div class="input-group">
          <input type="text" class="form-control" name="create[url]" id="create-url" placeholder="https://www.google.com" aria-describedby="shortlink-form-submit">
          <button type="button" class="btn btn-success waves-effect" id="shortlink-form-submit" onclick="indexPage.submitShortlink()">
            Go
          </button>
        </div>

      </form>

    </div>
  </div>

</div>

<script defer>
  indexPage = {
      submitShortlink: function () {
          console.log('here');

          const formURL = $('#create-url').val();

          if (!(/<%= URL_REGEX %>/.test(formURL))) {
              console.log('invalid');

              return;
          }


          let form = document.getElementById('shortlink-form');
          let url = '<%= site_create_shortlink_path %>';
          let formData = new FormData(form);

          let postForm = $.ajax({
              url: url,
              data: formData,
              cache: false,
              processData: false,
              contentType: false,
              type: 'POST',
              success: function (data) {
                  submitButton.attr('disabled', false);
                  createToast('<%= t 'global.forms.errors.submission_success' %>', data.info, '');
                  window.location.href = data.payment_url;
              }
          });

          postForm.fail(function (data) {
              submitButton.attr('disabled', false);
              if (data.responseJSON === undefined) {
                  createToast('', '<%= t 'global.forms.errors.unknown_error' %>', 'error');
              } else {
                  createToast('', data.responseJSON.info, 'error');
              }
          });
      }
  }
</script>

<% end %>